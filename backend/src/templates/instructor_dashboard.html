<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Schedule - UoM</title>
    <link rel="stylesheet" href="/static/css/instructor_dashboard.css">
</head>

<body>

    <div class="header">
        <div class="header-left">
            <span style="font-size: 24px;">üèõÔ∏è</span>
            <h1>Faculty of Engineering - {{ user.name }}</h1>
        </div>
        <a href="/logout" class="logout">Sign Out</a>
    </div>

    <div class="container">

        {% if request.query_params.success %}
        <div class="success-msg">‚úÖ {{ request.query_params.success }}</div>
        {% endif %}

        {% if request.query_params.error %}
        <div class="success-msg" style="color: #c62828; background: #ffebee; border-color: #ffcdd2;">
            ‚ùå {{ request.query_params.error }}
        </div>
        {% endif %}

        <div class="tab-container">
            <div id="btn-dashboard" class="tab active" onclick="openTab('dashboard')">üè† My Dashboard</div>
            <div id="btn-calendar" class="tab" onclick="openTab('calendar')">üóìÔ∏è Master Schedule</div>
        </div>

        <!-- MY DASHBOARD TAB -->
        <div id="dashboard" class="tab-content active">
            <!-- PROFILE CARD -->
            <div class="profile-card">
                <img src="{{ user.photo_url if user.photo_url else 'https://ui-avatars.com/api/?name=' + user.name + '&background=004d40&color=fff' }}"
                    class="profile-img" alt="Profile">
                <div class="profile-info">
                    <h2>{{ user.name }}</h2>
                    <div class="dept-role">{{ user.department_code }} | {{ user.role }}</div>
                    <div class="details">
                        {{ user.email }}
                        {% if user.university %} ‚Ä¢ {{ user.university }}{% endif %}
                        {% if user.degree %} ‚Ä¢ {{ user.degree }}{% endif %}
                    </div>
                </div>
                <div class="actions-bar">
                    <button onclick="openModal('pwd-modal')" class="btn-export btn-pwd">
                        üîí Change Password
                    </button>
                    <button onclick="openModal('leave-modal')" class="btn-export btn-leave">
                        üèñÔ∏è Request Leave
                    </button>
                    <a href="/export/ics" class="btn-export">
                        üìÖ Sync Own Schedule
                    </a>
                </div>
            </div>

            <div class="schedule-header">
                <h3>My Sessions</h3>
            </div>

            {% if schedule %}
            {% for session in schedule %}
            <div
                class="session-card status-{{ session.purpose|lower }} {% if session.booking_date < today %}past-session{% endif %}">
                <div class="date-box">
                    <span class="month">{{ session.booking_date.strftime('%b') }}</span>
                    <span class="day">{{ session.booking_date.strftime('%d') }}</span>
                    <span class="weekday">{{ session.booking_date.strftime('%a') }}</span>
                </div>
                <div class="details-box">
                    <div class="details-top">
                        <span class="module-title">
                            {{ session.module_code }}
                            <span class="tag tag-{{ session.purpose|lower }}">{{ session.purpose }}</span>
                        </span>
                        <span class="time-badge">
                            üïí {{ session.start_time.strftime('%H:%M') }} - {{ session.end_time.strftime('%H:%M') }}
                        </span>
                    </div>
                    <div class="details-bottom">
                        {% if session.practical_name %}
                        <div class="practical-name">{{ session.practical_name }}</div>
                        {% endif %}
                        <div class="lab-location">
                            üìç {{ session.lab.name }}
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
            {% else %}
            <div class="empty-state">
                <span class="empty-icon">‚òï</span>
                <h3>No upcoming sessions</h3>
                <p>Your schedule is clear for now.</p>
            </div>
            {% endif %}

            <!-- My Leaves Section -->
            <div class="schedule-header" style="margin-top: 30px;">
                <h3>My Leave Requests</h3>
            </div>
            {% if my_leaves %}
            <div class="leaves-container">
                <table>
                    <tr>
                        <th>Period</th>
                        <th>Reason</th>
                        <th>Status</th>
                    </tr>
                    {% for leave in my_leaves %}
                    <tr>
                        <td>{{ leave.start_date }} to {{ leave.end_date }}</td>
                        <td>{{ leave.reason if leave.reason else '-' }}</td>
                        <td>
                            <span
                                class="status-tag {% if leave.status == 'APPROVED' %}approved{% elif leave.status == 'REJECTED' %}rejected{% else %}pending{% endif %}">
                                {{ leave.status }}
                            </span>
                        </td>
                    </tr>
                    {% endfor %}
                </table>
            </div>
            {% else %}
            <p style="color:#888; text-align:center; padding:20px;">No leave history.</p>
            {% endif %}
        </div>

        <!-- CALENDAR TAB -->
        <div id="calendar" class="tab-content">
            <!-- AJAX Container -->
            <div id="calendar-container">
                {% include 'partials/calendar_grid.html' %}
            </div>
        </div>

        <!-- Leave Request Modal -->
        <div id="leave-modal" class="modal-overlay">
            <div class="modal-content large">
                <h3 style="margin-top:0;">Request Leave</h3>
                <span onclick="closeModal('leave-modal')" class="modal-close">‚úï</span>
                <form action="/leaves/request" method="POST">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                    <div class="form-group">
                        <label>Start Date</label>
                        <input type="date" name="start_date" required class="form-control">
                    </div>
                    <div class="form-group">
                        <label>End Date</label>
                        <input type="date" name="end_date" required class="form-control">
                    </div>
                    <div class="form-group">
                        <label>Reason</label>
                        <textarea name="reason" rows="3" class="form-control"></textarea>
                    </div>
                    <button type="submit" class="btn-export btn-leave" style="width:100%;">Submit Request</button>
                </form>
            </div>
        </div>

        <!-- Password Change Modal -->
        <div id="pwd-modal" class="modal-overlay">
            <div class="modal-content">
                <h3 style="margin-top:0;">Change Password</h3>
                <span onclick="closeModal('pwd-modal')" class="modal-close">‚úï</span>
                <form action="/auth/change-password" method="POST">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                    <div class="form-group">
                        <label>Current Password</label>
                        <input type="password" name="old_password" required class="form-control">
                    </div>
                    <div class="form-group">
                        <label>New Password</label>
                        <input type="password" name="new_password" required class="form-control">
                    </div>
                    <div class="form-group">
                        <label>Confirm Password</label>
                        <input type="password" name="confirm_password" required class="form-control">
                    </div>
                    <button type="submit" class="btn-export" style="width:100%;">Update Password</button>
                </form>
            </div>
        </div>

    </div>

    <script src="/static/js/instructor_dashboard.js"></script>
</body>

</html>