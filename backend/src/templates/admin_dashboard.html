<!DOCTYPE html>
<html>

<head>
    <title>Admin Dashboard</title>
    <link rel="stylesheet" href="/static/css/admin_dashboard.css">
</head>

<body>
    <div class="header">
        <h1>üèõÔ∏è Admin Dashboard - Welcome, {{ user.name }}</h1>
        <div style="display: flex; gap: 10px; align-items: center;">
            <button onclick="document.getElementById('pwd-modal').style.display='block'"
                class="btn-logout btn-change-pwd">üîí Change Pwd</button>
            <a href="/logout" class="btn-logout">Sign Out</a>
        </div>
    </div>

    {% if request.query_params.error %}
    <p class="error">{{ request.query_params.error }}</p>
    {% endif %}

    {% if request.query_params.success %}
    <p class="success">{{ request.query_params.success }}</p>
    {% endif %}

    <div class="tab-container">
        <div id="btn-calendar" class="tab active" onclick="openTab('calendar')">üóìÔ∏è Master Schedule</div>
        <div id="btn-bookings" class="tab" onclick="openTab('bookings')">üìù Manage Bookings</div>
        <div id="btn-labs" class="tab" onclick="openTab('labs')">üî¨ Labs</div>
        <div id="btn-modules" class="tab" onclick="openTab('modules')">üìö Modules</div>
        <div id="btn-instructors" class="tab" onclick="openTab('instructors')">üë®‚Äçüè´ Instructors</div>
        <div id="btn-leaves" class="tab" onclick="openTab('leaves')">Leaves
            {% if pending_count > 0 %}
            <span style="background:#d32f2f; color:white; border-radius:50%; padding:2px 6px; font-size:0.8em;">{{
                pending_count }}</span>
            {% endif %}
        </div>
    </div>

    <!-- CALENDAR TAB (Default) -->
    <div id="calendar" class="tab-content active">
        {% if unavailable_instructors_count > 0 %}
        <div class="warning-conflict">
            ‚ö†Ô∏è <strong>Warning:</strong> {{ unavailable_instructors_count }} Instructor(s) are unavailable (on leave)
            during scheduled classes in this view.
        </div>
        {% endif %}

        <div class="calendar-nav">
            <a href="/?month={{ prev_month }}&year={{ prev_year }}">‚óÄ Prev</a>
            <h2>{{ month_name }} {{ year }}</h2>
            <a href="/?month={{ next_month }}&year={{ next_year }}">Next ‚ñ∂</a>
        </div>
        <div class="calendar-grid">
            <!-- Headers -->
            <div class="calendar-header-cell">Mon</div>
            <div class="calendar-header-cell">Tue</div>
            <div class="calendar-header-cell">Wed</div>
            <div class="calendar-header-cell">Thu</div>
            <div class="calendar-header-cell">Fri</div>
            <div class="calendar-header-cell">Sat</div>
            <div class="calendar-header-cell">Sun</div>

            <!-- Days -->
            {% for week in calendar_weeks %}
            {% for day in week %}
            {% if day == 0 %}
            <div class="calendar-day empty"></div>
            {% else %}
            {% set date_str = year ~ '-' ~ ("%02d"|format(month)) ~ '-' ~ ("%02d"|format(day)) %}
            <div class="calendar-day {{ 'today' if date_str == today_str else '' }}">
                <div class="day-number">
                    {{ day }}
                    {% if date_str in bookings_by_date %}
                    <span
                        style="font-size:0.7em; background:#004d40; color:white; padding:2px 5px; border-radius:10px;">
                        {{ bookings_by_date[date_str]|length }}
                    </span>
                    {% endif %}
                </div>

                {% if date_str in bookings_by_date %}
                {% for b in bookings_by_date[date_str] %}
                <div class="booking-item">
                    <a href="/bookings/edit/{{ b.id }}"
                        class="booking-badge {{ 'booking-conflict' if b.is_conflict else '' }}">
                        {{ b.start_time.strftime('%H:%M') }} {{ b.module_code }}
                    </a>
                    <!-- Tooltip -->
                    <div class="booking-tooltip">
                        <div style="font-weight:bold; color:#80cbc4; margin-bottom:4px;">
                            {{ b.module_code }} <span style="font-weight:normal; color:#b2dfdb; font-size:0.9em;">- {{
                                b.practical_name }}</span>
                        </div>
                        <div>üìÖ {{ b.start_time.strftime('%H:%M') }} - {{ b.end_time.strftime('%H:%M') }}</div>
                        <div>üë®‚Äçüè´ {{ b.instructor.name }}</div>
                        <div style="margin-top:4px; font-style:italic; font-size:0.9em; color:#ddd;">{{ b.purpose }}
                        </div>
                        {% if b.lab %}
                        <div style="margin-top:2px;">üìç {{ b.lab.name }}</div>
                        {% endif %}

                        {% if b.is_conflict %}
                        <div
                            style="color:#d32f2f; font-weight:bold; margin-top:4px; border-top:1px solid rgba(255,255,255,0.1); padding-top:4px;">
                            ‚ö†Ô∏è INSTRUCTOR ON LEAVE</div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
                {% endif %}
            </div>
            {% endif %}
            {% endfor %}
            {% endfor %}
        </div>
    </div>

    <!-- BOOKINGS TAB -->
    <div id="bookings" class="tab-content">
        <form action="/bookings/create" method="POST" class="create-form">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            <!-- Row 1: Who & Where -->
            <div class="form-row">
                <div class="form-group">
                    <label>Lab Venue</label>
                    <select name="lab_id" required>
                        {% for l in active_labs %}
                        <option value="{{ l.id }}">{{ l.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label>Instructor</label>
                    <select name="instructor_id" required>
                        {% for i in active_instructors %}
                        <option value="{{ i.id }}">{{ i.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label>Semester Filter</label>
                    <select id="semester_select" onchange="filterModules()">
                        <option value="all">-- All --</option>
                        <option value="1">Sem 1</option>
                        <option value="2">Sem 2</option>
                        <option value="3">Sem 3</option>
                        <option value="4">Sem 4</option>
                        <option value="5">Sem 5</option>
                        <option value="6">Sem 6</option>
                        <option value="7">Sem 7</option>
                        <option value="8">Sem 8</option>
                    </select>
                </div>
            </div>

            <!-- Row 2: What -->
            <div class="form-row">
                <div class="form-group">
                    <label>Module</label>
                    <select name="module_code" id="module_select" required>
                        <option value="" disabled selected>-- Select --</option>
                        {% for m in active_modules %}
                        <option value="{{ m.code }}" data-sem="{{ m.semester }}">[{{ m.semester }}] {{ m.code }} - {{
                            m.title }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group" style="flex: 2;">
                    <label>Practical Name / Description</label>
                    <input type="text" name="practical_name" placeholder="e.g. Lab 01: Introduction" required>
                </div>
            </div>

            <!-- Row 3: When -->
            <div class="form-row">
                <div class="form-group">
                    <label>Date</label>
                    <input type="date" name="booking_date" required>
                </div>
                <div class="form-group">
                    <label>Start Time</label>
                    <input type="time" name="start_time" required>
                </div>
                <div class="form-group">
                    <label>End Time</label>
                    <input type="time" name="end_time" required>
                </div>
            </div>

            <!-- Row 4: Recurring (Separate Box) -->
            <div class="recurring-section">
                <div class="checkbox-wrapper">
                    <input type="checkbox" id="is_recurring" name="is_recurring" onchange="toggleRecurring()">
                    <label for="is_recurring">Repeat Weekly</label>
                </div>
                <div id="recurring_end_div">
                    <label>Repeat Until Date</label>
                    <input type="date" name="repeat_until" id="repeat_until">
                </div>
            </div>

            <button type="submit" class="btn-primary">Confirm Booking</button>
        </form>

        <h3>Current Schedule</h3>
        <table>
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Time</th>
                    <th>Lab</th>
                    <th>Mod</th>
                    <th>Instructor</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% for b in bookings %}
                <tr>
                    <td>{{ b.booking_date }}</td>
                    <td>{{ b.start_time }} - {{ b.end_time }}</td>
                    <td>{{ b.lab.name }}</td>
                    <td>{{ b.module_code }}</td>
                    <td>{{ b.instructor.name }}</td>
                    <td class="action-cell">
                        <a href="/bookings/edit/{{ b.id }}" class="btn-edit">Edit</a>
                        <form action="/bookings/delete/{{ b.id }}" method="POST" style="display:inline;"
                            onsubmit="return confirm('Delete?');">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                            <button class="btn-delete">Del</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- LABS TAB -->
    <div id="labs" class="tab-content">
        <form action="/labs/create" method="POST" class="create-form">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            <div class="form-row">
                <div class="form-group">
                    <label>Name</label>
                    <input type="text" name="name" required>
                </div>
                <div class="form-group">
                    <label>Dept</label>
                    <select name="dept">
                        {% for d in departments %}
                        <option value="{{ d.code }}">{{ d.code }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label>Capacity</label>
                    <input type="number" name="capacity" required>
                </div>
            </div>
            <button type="submit" class="btn-primary">Add Lab</button>
        </form>

        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Dept</th>
                    <th>Status</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% for l in all_labs %}
                <tr class="{{ 'status-inactive' if not l.is_active else '' }}">
                    <td>{{ l.id }}</td>
                    <td>{{ l.name }}</td>
                    <td>{{ l.department_code }}</td>
                    <td>{{ 'Active' if l.is_active else 'Inactive' }}</td>
                    <td class="action-cell">
                        <form action="/labs/toggle/{{ l.id }}" method="POST" style="display:inline;">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                            <button class="btn-toggle">{{ 'Disable' if l.is_active else 'Enable' }}</button>
                        </form>
                        <a href="/labs/edit/{{ l.id }}" class="btn-edit">Edit</a>
                        <form action="/labs/delete/{{ l.id }}" method="POST" style="display:inline;"
                            onsubmit="return confirm('Delete?');">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                            <button class="btn-delete">Del</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- MODULES TAB -->
    <div id="modules" class="tab-content">
        <form action="/modules/create" method="POST" class="create-form">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            <div class="form-row">
                <div class="form-group">
                    <label>Code</label>
                    <input type="text" name="code" required>
                </div>
                <div class="form-group">
                    <label>Title</label>
                    <input type="text" name="title" required>
                </div>
                <div class="form-group">
                    <label>Dept</label>
                    <select name="dept">
                        {% for d in departments %}
                        <option value="{{ d.code }}">{{ d.code }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label>Semester</label>
                    <input type="number" name="semester" min="1" max="8" required>
                </div>
            </div>
            <button type="submit" class="btn-primary">Add Module</button>
        </form>

        <table>
            <thead>
                <tr>
                    <th>Code</th>
                    <th>Title</th>
                    <th>Sem</th>
                    <th>Status</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% for m in all_modules %}
                <tr class="{{ 'status-inactive' if not m.is_active else '' }}">
                    <td>{{ m.code }}</td>
                    <td>{{ m.title }}</td>
                    <td>{{ m.semester }}</td>
                    <td>{{ 'Active' if m.is_active else 'Inactive' }}</td>
                    <td class="action-cell">
                        <form action="/modules/toggle/{{ m.code }}" method="POST" style="display:inline;">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                            <button class="btn-toggle">{{ 'Disable' if m.is_active else 'Enable' }}</button>
                        </form>
                        <a href="/modules/edit/{{ m.code }}" class="btn-edit">Edit</a>
                        <form action="/modules/delete/{{ m.code }}" method="POST" style="display:inline;"
                            onsubmit="return confirm('Delete?');">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                            <button class="btn-delete">Del</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- INSTRUCTORS TAB -->
    <div id="instructors" class="tab-content">
        <form action="/instructors/create" method="POST" class="create-form">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            <div class="form-row">
                <div class="form-group"><label>Name</label><input type="text" name="name" required></div>
                <div class="form-group"><label>Email</label><input type="email" name="email" required></div>
                <div class="form-group">
                    <label>Dept</label>
                    <select name="dept">
                        {% for d in departments %}
                        <option value="{{ d.code }}">{{ d.code }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label>Role</label>
                    <select name="role">
                        <option value="INSTRUCTOR" selected>INSTRUCTOR</option>
                        <option value="ADMIN">ADMIN</option>
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group"><label>University</label><input type="text" name="university"></div>
                <div class="form-group"><label>Degree</label><input type="text" name="degree"></div>
                <div class="form-group"><label>Graduated</label><input type="date" name="graduated_date"></div>
            </div>
            <div class="form-row">
                <div class="form-group"><label>Photo URL</label><input type="text" name="photo_url"></div>
            </div>
            <button type="submit" class="btn-primary">Add Instructor</button>
        </form>

        <div class="grid-container">
            {% for i in all_instructors %}
            <div class="instructor-card {{ 'status-inactive' if not i.is_active else '' }}">
                <img src="{{ i.photo_url if i.photo_url else 'https://ui-avatars.com/api/?name=' + i.name + '&background=004d40&color=fff' }}"
                    class="instructor-img" alt="{{ i.name }}">
                <div class="instructor-name">{{ i.name }}</div>
                <div class="instructor-meta">{{ i.department_code }} | {{ i.role }}</div>
                <div class="instructor-details">
                    {{ i.email }}<br>
                    {% if i.university %}{{ i.university }}{% endif %}
                    {% if i.degree %}<br>{{ i.degree }}{% endif %}
                </div>
                <div class="card-actions">
                    <form action="/instructors/toggle/{{ i.id }}" method="POST" style="display:inline;">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                        <button class="btn-toggle">{{ 'Disable' if i.is_active else 'Enable' }}</button>
                    </form>

                    {% if user.role == 'SUPER_ADMIN' or (user.role == 'ADMIN' and i.role == 'INSTRUCTOR') %}
                    <form action="/auth/reset-password/{{ i.id }}" method="POST" style="display:inline;"
                        onsubmit="return confirm('Reset password to default (password123)?');">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                        <button class="btn-toggle"
                            style="background:#ffecb3; border-color:#e6c200; color:#8d7800;">Reset Pwd</button>
                    </form>
                    {% endif %}

                    <a href="/instructors/edit/{{ i.id }}" class="btn-edit">Edit</a>
                    <form action="/instructors/delete/{{ i.id }}" method="POST" style="display:inline;"
                        onsubmit="return confirm('Delete?');">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                        <button class="btn-delete">Del</button>
                    </form>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- LEAVES TAB -->
    <div id="leaves" class="tab-content">
        <h3>Pending Leave Requests</h3>
        {% if pending_leaves %}
        <table>
            <thead>
                <tr>
                    <th>Instructor</th>
                    <th>Period</th>
                    <th>Reason</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for leave in pending_leaves %}
                <tr>
                    <td>{{ leave.instructor.name }}</td>
                    <td>{{ leave.start_date }} to {{ leave.end_date }}</td>
                    <td>{{ leave.reason }}</td>
                    <td>
                        <form action="/leaves/{{ leave.id }}/approve" method="POST" style="display:inline;">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                            <button class="btn-toggle"
                                style="background:#c8e6c9; color:#2e7d32; border-color:#a5d6a7;">Approve</button>
                        </form>
                        <form action="/leaves/{{ leave.id }}/reject" method="POST" style="display:inline;"
                            onsubmit="return confirm('Reject this leave?');">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                            <button class="btn-toggle"
                                style="background:#ffcdd2; color:#c62828; border-color:#ef9a9a;">Reject</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p class="success">No pending leave requests.</p>
        {% endif %}
    </div>

    <!-- Password Change Modal -->
    <div id="pwd-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 style="margin-top:0;">Change Password</h3>
            <span onclick="document.getElementById('pwd-modal').style.display='none'" class="modal-close">‚úï</span>
            <form action="/auth/change-password" method="POST">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                <div style="margin-bottom:10px;">
                    <label style="display:block; margin-bottom:5px; font-weight:600;">Current Password</label>
                    <input type="password" name="old_password" required
                        style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px; box-sizing:border-box;">
                </div>
                <div style="margin-bottom:10px;">
                    <label style="display:block; margin-bottom:5px; font-weight:600;">New Password</label>
                    <input type="password" name="new_password" required
                        style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px; box-sizing:border-box;">
                </div>
                <div style="margin-bottom:15px;">
                    <label style="display:block; margin-bottom:5px; font-weight:600;">Confirm Password</label>
                    <input type="password" name="confirm_password" required
                        style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px; box-sizing:border-box;">
                </div>
                <button type="submit"
                    style="background:#004d40; color:white; padding:10px; border:none; width:100%; border-radius:4px; cursor:pointer; font-weight:bold;">Update
                    Password</button>
            </form>
        </div>
    </div>

    <script src="/static/js/admin_dashboard.js"></script>
</body>

</html>